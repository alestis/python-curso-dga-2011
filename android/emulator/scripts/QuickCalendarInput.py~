try:
  from xml.etree import ElementTree # for Python 2.5 users
except ImportError:
  from elementtree import ElementTree
import gdata.calendar.service
import gdata.service
import atom.service
import gdata.calendar
import atom
import android
import sys
import time
from string import split
from string import find

droid = android.Android()

def AddReminder(calendar_service, event, minutes=10):
  for a_when in event.when:
    if len(a_when.reminder) > 0:
      a_when.reminder[0].minutes = minutes
    else:
      a_when.reminder.append(gdata.calendar.Reminder(minutes=minutes))
  
  while True:
    # Sometime Google Calendar service returns an error. This keeps trying until there's no error.
    try:
      calendar_service.UpdateEvent(event.GetEditLink().href, event)
      break
    except gdata.service.RequestError as inst:
      if inst[0]['status'] == 302:
        time.sleep(1.0)
        continue
      raise
    except:
      raise

# The next 4 lines get the parameters passed from Tasker and assign them to the variables they represent.
#params = droid.getIntent().result[u'extras']
#for key in params.keys():
#  if key.startswith('%'):
#    exec key.lstrip('%') + '="' + params[key] + '"'

EMAIL_USER = 'rengar666@gmail.com'
EMAIL_PSWD = '1maysun8'
CAL_SPEECH = ''
CAL_REMINDER = ''
CAL_QUICKADD = 'Prueba Google Calendar'


if EMAIL_USER.find('@') < 0:
  EMAIL_USER += '@gmail.com'
  
if CAL_SPEECH:
  texto = droid.dialogGetInput("Texto cita","Texto:")
  CAL_QUICKADD = texto[1]
  
if CAL_QUICKADD:
  calendar_service = gdata.calendar.service.CalendarService()
  calendar_service.email = EMAIL_USER
  calendar_service.password = EMAIL_PSWD
  calendar_service.source = 'Android'
  calendar_service.ProgrammaticLogin()

  event = gdata.calendar.CalendarEventEntry()
  event.content = atom.Content(text=CAL_QUICKADD)
  event.quick_add = gdata.calendar.QuickAdd(value='true')

  # Send the request and receive the response:
  while True:
    # Sometime Google Calendar service returns an error. This keeps trying until there's no error.
    try:
      new_event = calendar_service.InsertEvent(event, '/calendar/feeds/default/private/full')
      break
    except gdata.service.RequestError as inst:
      if inst[0]['status'] == 302:
        time.sleep(1.0)
        continue
      raise
    except:
      raise
    
  if CAL_REMINDER:
    AddReminder(calendar_service, new_event, minutes=CAL_REMINDER)
    
  if CAL_SPEECH:    
    cal_event = new_event.title.text + '\n' 
    for a_when in new_event.when:
      d = split(a_when.start_time, 'T')
      try:
        s = split(d[1], ':00.')
      except:
        s = ('',)
      cal_event += 'Start: ' + d[0] + ' ' + s[0] + '\n'
      d = split(a_when.end_time, 'T')
      try:
        s = split(d[1], ':00.')
      except:
        s = ('',)
      cal_event += '  End: ' + d[0] + ' ' + s[0] + '\n'
    droid.dialogCreateAlert('New Calendar Entry', cal_event)
    droid.dialogSetNegativeButtonText('Edit')
    droid.dialogSetPositiveButtonText('OK')
    droid.dialogShow()
    if droid.dialogGetResponse().result['which'] == 'negative':
      time.sleep(2.0)
      droid.view(new_event.GetHtmlLink().href)

